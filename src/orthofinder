# Global variables
MICROSPORIDIA_SPECIES = glob_wildcards("../data/proteome_pairs/{species}_S_cere").species
PROTEOME_PAIRS = expand("../data/proteome_pairs/{species}_S_cere", species = MICROSPORIDIA_SPECIES)
BLAST_CMD = "../data/orthofinder_blast/blast_commands"
LOCAL_DIR = "\/home\/boognish\/Desktop\/smsk_microsporidia_domains"
SLURM_SCRIPT = "./slurm_blast.sh"


localrules: all, generate_blast_commands, clean


rule all:
    input: SLURM_SCRIPT


rule generate_blast_commands:
    input: PROTEOME_PAIRS
    output: BLAST_CMD
    run:
        # create file collecting all blast commands to run
        os.system(f"touch {BLAST_CMD}")

        for i in range(len(MICROSPORIDIA_SPECIES)):
            species = MICROSPORIDIA_SPECIES[i]
            input_folder = PROTEOME_PAIRS[i]
            output_file = f"../data/orthofinder_blast/{species}_S_cere"
            
            # generate text file of blast commands
            os.system(f"orthofinder -S blast -op -f {input_folder} > {output_file}")
            os.system(f"sed -i 1,20d {output_file}")  # remove headers from each blast command
            os.system(f"sed -i 's/{LOCAL_DIR}/../g' {output_file}")
            os.system(f"cat {output_file} >> {BLAST_CMD}")


# run blast commands from generate_blast_commands, to generate blast databases for each microsporidia
# species for Orthofinder
rule execute_blast_commands:
    input: BLAST_CMD
    output: SLURM_SCRIPT
    run:
        script = '''#SBATCH --output=report
#SBATCH --cpus-per-task=4
#SBATCH --time=04:00:00
#SBATCH --mem-per-cpu=2GB
#SBATCH --mail-user=jasonbitan.jiang@mail.utoronto.ca
#SBATCH --mail-type=BEGIN
#SBATCH --mail-type=END
#SBATCH --mail-type=FAIL

module load StdEnv/2018.3
module load nixpkgs/16.09
module load gcc/7.3.0
module load blast+/2.7.1
module load parallel/20160722
        
parallel < {0}
        '''.format(BLAST_CMD)

        print(script)

        with open(SLURM_SCRIPT, 'w') as f:
            f.write(script)


# Removes all output generated by this snakefile
rule clean:
    shell:
        """
        rm ../data/orthofinder_blast/* &&\
        rm -r ../data/proteome_pairs/*/OrthoFinder
        """